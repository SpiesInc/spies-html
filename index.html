<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Status Viewer</title>
    <style>
        :root {
            --discord-dark: #36393f;
            --discord-darker: #2f3136;
            --discord-light: #dcddde;
            --discord-green: #3ba55c;
            --discord-yellow: #faa61a;
            --discord-red: #ed4245;
            --discord-gray: #747f8d;
            --spotify-green: #1DB954;
            --spotify-black: #191414;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: black;
            color: var(--discord-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }


        .logo {
            width: 150px;
            height: auto;
            display: block;
            margin: 0 auto 20px;
        }

        .wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
        .container {
        width: 100%;
        max-width: 400px;
        background-color: var(--discord-dark);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .user-card {
            padding: 20px;
        }

        .user-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--discord-darker);
            overflow: visible;
            position: relative;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .status-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--discord-gray);
            bottom: 0;
            right: 0;
            border: 4px solid var(--discord-dark);
            z-index: 2;
        }

        .status-online {
            background-color: var(--discord-green);
        }

        .status-idle {
            background-color: var(--discord-yellow);
        }

        .status-dnd {
            background-color: var(--discord-red);
        }

        .user-info {
            margin-left: 20px;
        }

        .user-id {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .user-status {
            font-size: 14px;
            color: var(--discord-gray);
            text-transform: capitalize;
        }

        .activity-card {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--discord-darker);
            border-radius: 8px;
        }

        .activity-type {
            font-size: 12px;
            color: var(--discord-gray);
            margin-bottom: 10px;
        }

        .game-activity {
            font-size: 14px;
            color: var(--discord-light);
        }

        .spotify-activity {
            display: flex;
            align-items: center;
        }

        .spotify-art {
            width: 64px;
            height: 64px;
            border-radius: 4px;
            margin-right: 15px;
            background-color: var(--spotify-black);
        }

        .spotify-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .spotify-info {
            flex: 1;
        }

        .spotify-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .spotify-artist {
            font-size: 14px;
            color: var(--discord-gray);
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .spotify-album {
            font-size: 12px;
            color: var(--discord-gray);
            margin-bottom: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--spotify-green);
            transition: width 1s linear;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--discord-gray);
            margin-top: 4px;
        }

        .spotify-logo {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .spotify-logo span {
            font-size: 12px;
            font-weight: 600;
            color: var(--spotify-green);
            margin-left: 5px;
        }

        .user-form {
            background-color: var(--discord-darker);
            padding: 15px;
            border-radius: 0 0 8px 8px;
            display: flex;
        }

        .user-input {
            flex: 1;
            background-color: #40444b;
            border: none;
            border-radius: 4px;
            color: var(--discord-light);
            padding: 10px 15px;
            font-size: 14px;
        }

        .user-input:focus {
            outline: none;
        }

        .fetch-btn {
            background-color: var(--discord-green);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            margin-left: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .fetch-btn:hover {
            background-color: #359052;
        }

        .error-message {
            color: var(--discord-red);
            text-align: center;
            padding: 20px;
            display: none;
        }

        .hidden {
            display: none;
        }

        /* Spotify logo SVG */
        .spotify-icon {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <img src="https://media.discordapp.net/attachments/1359088438095249432/1359240809446113361/spies.png?ex=67f6c326&is=67f571a6&hm=126de5d98c86f636d7dbde8fcfe49c5076f97a5ec623d8665ad79c385574f9fe&=&format=webp&quality=lossless&width=585&height=198" class="logo" alt="Logo">
    <div class="container">
        <div class="user-card hidden" id="userCard">
            <div class="user-header">
                <div class="avatar">
                    <img id="userAvatar" src="/api/placeholder/80/80" alt="User Avatar">
                    <div class="status-indicator" id="statusIndicator"></div>
                </div>
                <div class="user-info">
                    <div class="user-id" id="userId">Username</div>
                    <div class="user-status" id="userStatus">unknown</div>
                </div>
            </div>
            
            <!-- Game Activity -->
            <div class="activity-card hidden" id="gameActivity">
                <div class="activity-type">PLAYING A GAME</div>
                <div class="game-activity" id="gameName"></div>
            </div>
            
            <!-- Spotify Activity -->
            <div class="activity-card hidden" id="spotifyActivity">
                <div class="activity-type">LISTENING TO SPOTIFY</div>
                <div class="spotify-activity">
                    <div class="spotify-art">
                        <img id="spotifyArt" src="/api/placeholder/64/64" alt="Album Cover">
                    </div>
                    <div class="spotify-info">
                        <div class="spotify-title" id="spotifyTitle">Song Title</div>
                        <div class="spotify-artist" id="spotifyArtist">Artist</div>
                        <div class="spotify-album" id="spotifyAlbum">Album</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="time-display">
                            <span id="currentTime">0:00</span>
                            <span id="totalTime">0:00</span>
                        </div>
                        <div class="spotify-logo">
                            <svg class="spotify-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z" fill="#1DB954"/>
                                <path d="M16.5 10.7376C14.1754 9.32247 10.8287 9.1 8.01791 9.82247C7.55717 9.93212 7.09326 9.65459 6.98326 9.19459C6.87362 8.73424 7.15114 8.27033 7.61114 8.16033C10.8287 7.33247 14.6006 7.58601 17.3328 9.2376C17.7574 9.48108 17.8917 10.0165 17.648 10.441C17.4046 10.8652 16.869 10.9996 16.4452 10.7559L16.5 10.7376ZM16.2334 13.1977C16.0263 13.5411 15.5966 13.6477 15.2531 13.4406C13.3 12.2477 10.6591 11.808 8.4025 12.4229C8.0146 12.5257 7.61789 12.2954 7.51511 11.9074C7.41232 11.5194 7.64275 11.1229 8.03062 11.02C10.6939 10.3017 13.7 10.798 15.99 12.2174C16.3334 12.4246 16.44 12.8543 16.2329 13.1977H16.2334ZM15.1554 15.5634C14.9906 15.8337 14.6419 15.9189 14.3716 15.754C12.65 14.7497 10.6733 14.5014 8.60038 14.9977C8.29294 15.0754 7.98115 14.8889 7.90326 14.5817C7.82558 14.2743 8.01223 13.9626 8.31936 13.8846C10.6546 13.326 12.888 13.612 14.8647 14.7791C15.135 14.944 15.2203 15.2931 15.0554 15.5634V15.5634Z" fill="#191414"/>
                            </svg>
                            <span>Spotify</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="error-message" id="errorMessage">
            User not found or API error
        </div>
        
        <div class="user-form">
            <input type="text" class="user-input" id="userIdInput" placeholder="Enter Discord User ID">
            <button class="fetch-btn" id="fetchBtn">Fetch Status</button>
        </div>
    </div>
</div>

    <script>
        // DOM elements
        const userCard = document.getElementById('userCard');
        const errorMessage = document.getElementById('errorMessage');
        const userIdInput = document.getElementById('userIdInput');
        const fetchBtn = document.getElementById('fetchBtn');
        const userId = document.getElementById('userId');
        const userAvatar = document.getElementById('userAvatar');
        const userStatus = document.getElementById('userStatus');
        const statusIndicator = document.getElementById('statusIndicator');
        const gameActivity = document.getElementById('gameActivity');
        const gameName = document.getElementById('gameName');
        const spotifyActivity = document.getElementById('spotifyActivity');
        const spotifyArt = document.getElementById('spotifyArt');
        const spotifyTitle = document.getElementById('spotifyTitle');
        const spotifyArtist = document.getElementById('spotifyArtist');
        const spotifyAlbum = document.getElementById('spotifyAlbum');
        const progressFill = document.getElementById('progressFill');
        const currentTime = document.getElementById('currentTime');
        const totalTime = document.getElementById('totalTime');

        // Hardcoded API URL
        const API_URL = "https://api.spies.rest";

        // Variables for Spotify playback tracking
        let progressInterval;
        let totalDuration = 0;
        let lastApiTimestamp = 0;
        let lastApiProgress = 0;
        let currentTrackTitle = "";
        let currentTrackArtist = "";
        let autoUpdateTimer = null;
        let songEndTimer = null;

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateProgress() {
            if (!lastApiTimestamp) return;
            
            // Calculate how much time has passed since we got the API data
            const now = Date.now() / 1000; // Current time in seconds
            const timePassedSinceUpdate = now - lastApiTimestamp;
            
            // Current position = progress reported by API + time passed since API update
            const currentPosition = lastApiProgress + timePassedSinceUpdate;
            
            if (currentPosition >= totalDuration) {
                // Song should be finished - auto refresh to check for a new song
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                currentTime.textContent = formatTime(totalDuration);
                
                // Schedule a refresh shortly after the song should have ended
                if (!songEndTimer) {
                    songEndTimer = setTimeout(() => {
                        fetchUserData();
                        songEndTimer = null;
                    }, 2000); // Wait 2 seconds after song end to refresh
                }
                return;
            }
            
            // Update progress bar
            const progressPercent = (currentPosition / totalDuration) * 100;
            progressFill.style.width = `${Math.min(progressPercent, 100)}%`;
            currentTime.textContent = formatTime(currentPosition);
        }

        // Fetch user data from API
        function fetchUserData() {
            const inputId = userIdInput.value.trim();
            
            // Save value to localStorage
            localStorage.setItem('userId', inputId);
            
            // Validate user ID
            if (!inputId || isNaN(inputId)) {
                showError("Please enter a valid Discord User ID");
                return;
            }
            
            // Using the hardcoded API URL
            const fullUrl = `${API_URL}/user/status/${inputId}`;
            
            // Display loading state only on first load
            if (userCard.classList.contains('hidden')) {
                showError("Fetching user data...");
            }
            
            fetch(fullUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayUserData(data);
                    
                    // Set up regular polling for song changes
                    setupAutoSongCheck();
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    showError(`Failed to fetch user data: ${error.message}`);
                });
        }

        function setupAutoSongCheck() {
            // Clear existing timer
            if (autoUpdateTimer) {
                clearTimeout(autoUpdateTimer);
            }
            
            // Set up a new timer to check for song changes
            autoUpdateTimer = setTimeout(() => {
                checkForSongChange();
            }, 15000); // Check every 15 seconds
        }

        function checkForSongChange() {
            const inputId = userIdInput.value.trim();
            
            if (!inputId) return;
            
            const fullUrl = `${API_URL}/user/status/${inputId}`;
            
            fetch(fullUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Check if there's a song change or activity change
                    const hasSpotifyActivity = data.activity && data.activity.type === "Spotify";
                    
                    if (hasSpotifyActivity) {
                        const newTrackTitle = data.activity.track;
                        const newTrackArtist = data.activity.artist;
                        
                        // If song changed, update the display
                        if (newTrackTitle !== currentTrackTitle || newTrackArtist !== currentTrackArtist) {
                            console.log("Song changed! Updating display...");
                            displayUserData(data);
                        } else {
                            // Only update the progress if it's the same song
                            updateSpotifyProgress(data.activity);
                        }
                    } else if (currentTrackTitle) {
                        // Had a song before, but not anymore - update display
                        displayUserData(data);
                    }
                    
                    // Set up next check
                    setupAutoSongCheck();
                })
                .catch(error => {
                    console.error('Error checking for song change:', error);
                    // Try again later even on error
                    setupAutoSongCheck();
                });
        }

        function updateSpotifyProgress(activity) {
            // Update progress tracking variables
            lastApiProgress = activity.progress || 0;
            lastApiTimestamp = activity.timestamp || (Date.now() / 1000);
            totalDuration = activity.duration || 0;
            
            // Update time displays
            currentTime.textContent = formatTime(lastApiProgress);
            
            // Set progress bar
            const progressPercent = (lastApiProgress / totalDuration) * 100;
            progressFill.style.width = `${Math.min(progressPercent, 100)}%`;
        }

        function displayUserData(data) {
            // Clear any existing intervals and timers
            if (progressInterval) {
                clearInterval(progressInterval);
            }
            if (songEndTimer) {
                clearTimeout(songEndTimer);
                songEndTimer = null;
            }
            
            // Reset visibility
            errorMessage.style.display = 'none';
            userCard.classList.remove('hidden');
            gameActivity.classList.add('hidden');
            spotifyActivity.classList.add('hidden');
            
            // Display user info
            userId.textContent = data.username ? data.username : `User ${data.user_id}`;
            userStatus.textContent = data.status;
            
            // Set avatar if available
            if (data.avatar_url) {
                userAvatar.src = data.avatar_url;
            } else {
                userAvatar.src = '/api/placeholder/80/80';
            }
            
            // Set status indicator color
            statusIndicator.className = 'status-indicator';
            if (data.status === 'online') {
                statusIndicator.classList.add('status-online');
            } else if (data.status === 'idle') {
                statusIndicator.classList.add('status-idle');
            } else if (data.status === 'dnd') {
                statusIndicator.classList.add('status-dnd');
            }
            
            // Clear track info
            currentTrackTitle = "";
            currentTrackArtist = "";
            
            // Handle activity display
            if (data.activity) {
                if (typeof data.activity === 'string' && data.activity.startsWith('Playing')) {
                    // Game activity
                    gameActivity.classList.remove('hidden');
                    gameName.textContent = data.activity.replace('Playing ', '');
                } else if (data.activity && data.activity.type === 'Spotify') {
                    // Spotify activity
                    spotifyActivity.classList.remove('hidden');
                    
                    // Update current track info for change detection
                    currentTrackTitle = data.activity.track;
                    currentTrackArtist = data.activity.artist;
                    
                    spotifyTitle.textContent = currentTrackTitle;
                    spotifyArtist.textContent = currentTrackArtist;
                    spotifyAlbum.textContent = data.activity.album;
                    
                    if (data.activity.image_url) {
                        spotifyArt.src = data.activity.image_url;
                    } else {
                        spotifyArt.src = '/api/placeholder/64/64';
                    }
                    
                    // Get timestamps and calculate start time
                    totalDuration = data.activity.duration || 0;
                    lastApiProgress = data.activity.progress || 0;
                    lastApiTimestamp = data.activity.timestamp || (Date.now() / 1000);
                    
                    // Update time displays
                    currentTime.textContent = formatTime(lastApiProgress);
                    totalTime.textContent = formatTime(totalDuration);
                    
                    // Set initial progress
                    const progressPercent = (lastApiProgress / totalDuration) * 100;
                    progressFill.style.width = `${Math.min(progressPercent, 100)}%`;
                    
                    // Start progress interval - update more frequently for smoother animation
                    progressInterval = setInterval(updateProgress, 250);
                }
            }
        }

        function showError(message) {
            userCard.classList.add('hidden');
            errorMessage.innerHTML = message;
            errorMessage.style.display = 'block';
        }

        // Load saved settings from localStorage
        function loadSavedSettings() {
            const savedUserId = localStorage.getItem('userId');
            
            if (savedUserId) {
                userIdInput.value = savedUserId;
                // Auto-fetch if we have a saved user ID
                fetchUserData();
            }
        }

        // Event listeners
        fetchBtn.addEventListener('click', fetchUserData);
        userIdInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fetchUserData();
            }
        });

        // Initialize
        showError("Enter a Discord User ID to fetch status");
        loadSavedSettings(); // Load any saved settings
    </script>    
</body>
</html>